generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

enum Role {
  SUPER_ADMIN
  ADMIN
  MANAGER
  SALES
  SUPPORT
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  LOST
}

enum DealStage {
  QUALIFICATION
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

enum ActivityType {
  NOTE
  CALL
  MEETING
  TASK
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())

  users      User[]
  companies  Company[]
  contacts   Contact[]
  leads      Lead[]
  deals      Deal[]
  settings   Setting[]
  activities Activity[]
  auditLogs  AuditLog[]

  @@index([slug])
  @@map("tenants")
}

model User {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  email        String   @unique
  passwordHash String
  name         String?
  role         Role     @default(SALES)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  refreshTokens RefreshToken[]
  assignedLeads Lead[]         @relation("AssignedLeads")
  assignedDeals Deal[]         @relation("AssignedDeals")

  activities Activity[] @relation("UserActivities")
  auditLogs  AuditLog[] @relation("UserAuditLogs")

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  @@map("refresh_tokens")
}

model Company {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  name      String
  website   String?
  phone     String?
  address   String?
  createdAt DateTime @default(now())

  contacts Contact[]
  deals    Deal[]

  @@index([tenantId])
  @@index([name])
  @@map("companies")
}

model Contact {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  firstName String
  lastName  String?
  email     String?
  phone     String?
  createdAt DateTime @default(now())

  leads Lead[] // <-- back relation for Lead.contact

  @@index([tenantId])
  @@index([email])
  @@map("contacts")
}

model Lead {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  title       String
  description String?
  source      String?
  status      LeadStatus @default(NEW)

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id])

  assignedToId String?
  assignedTo   User?   @relation("AssignedLeads", fields: [assignedToId], references: [id])

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([status])
  @@map("leads")
}

model Deal {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  title       String
  amount      Float?
  probability Int?
  stage       DealStage @default(QUALIFICATION)

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  assignedToId String?
  assignedTo   User?   @relation("AssignedDeals", fields: [assignedToId], references: [id])

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([stage])
  @@map("deals")
}

model Activity {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  actorId String?
  actor   User?   @relation("UserActivities", fields: [actorId], references: [id])

  type ActivityType

  targetType String // "Lead" | "Contact" | "Deal" | "Company"
  targetId   String

  body      String?
  dueAt     DateTime?
  completed Boolean   @default(false)
  createdAt DateTime  @default(now())

  @@index([tenantId])
  @@index([targetType, targetId])
  @@map("activities")
}

model AuditLog {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  userId String?
  user   User?   @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: Cascade)

  action     String
  resource   String
  resourceId String
  meta       Json?
  createdAt  DateTime @default(now())

  @@index([tenantId])
  @@index([resource, resourceId])
  @@map("auditlogs")
}

model Setting {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  key       String
  value     String
  createdAt DateTime @default(now())

  @@unique([tenantId, key])
  @@map("settings")
}
